name: Build Docker Image, Deploy to EC2
on:
  push:
    branches:
      - main
      - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:
    inputs:
      ref:
        description: 'Git ref or branch to run the workflow on'
        required: false
        default: 'main'
      deploy_to_ec2:
        description: 'Whether to deliver code to EC2 after build'
        required: true
        default: true
        type: boolean

jobs:
  build-and-test:
    environment: "Development"
    name: Build and Test CQRS Application
    
    runs-on: ubuntu-latest
    env:
      DB_URL: ${{ secrets.DB_URL }}
      DB_USERNAME: ${{ vars.DB_USERNAME }}
      DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
      HOST_IP: ${{ vars.EC2_PUBLIC_IP }}
      AUTH0_DOMAIN: ${{ vars.AUTH0_DOMAIN }}
      AUTH0_CLIENT_ID: ${{ vars.AUTH0_CLIENT_ID }}
      AUTH0_CLIENT_SECRET: ${{ secrets.AUTH0_CLIENT_SECRET }}
    steps:
      - name: Checkout repository with submodules
        uses: actions/checkout@v4
        with:
          submodules: 'recursive'
      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ vars.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      
      - name: Test Build, Push All images with Docker Buildx
        run: |
          docker buildx bake -f docker/docker-bake.hcl --push
  deliver-code-via-ssh:
    needs: build-and-test
    environment: "Development"
    name: Deliver Code to EC2 Instance via SSH
    runs-on: ubuntu-latest
    env:
      BRANCH_NAME: ${{ github.head_ref || github.ref_name }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      - name: Set up SSH private key and known_hosts
        run: |
          set -euo pipefail
          mkdir -p ~/.ssh
          # write key safely (preserves newlines)
          sudo printf '%s\n' "${{ secrets.EC2_SSH_PRIVATE_KEY }}" > ~/.ssh/my_ec2_key
          sudo chmod 600 ~/.ssh/my_ec2_key

          # add host key to known_hosts to avoid interactive prompt
          if [ -n "${{ vars.EC2_PUBLIC_IP }}" ]; then
            sudo ssh-keyscan -H "${{ vars.EC2_PUBLIC_IP }}" >> ~/.ssh/known_hosts || true
            sudo chmod 600 ~/.ssh/known_hosts
          fi
      - name: Deliver Code to EC2
        run: |
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/my_ec2_key ubuntu@${{ vars.EC2_PUBLIC_IP }} <<EOF
          
            echo "--- Checkout Latest Compose File from $BRANCH_NAME branch: ---"
            cd /home/ubuntu/Accounting_CQRS_Project
            git reset --hard HEAD
            git checkout $BRANCH_NAME
            git pull origin $BRANCH_NAME

            echo "--- Setup Environment Variables outside git repo: ---"
            echo "DB_URL=${{ secrets.DB_URL }}"                             >  env.properties
            echo "DB_USERNAME=${{ vars.DB_USERNAME }}"                      >> env.properties
            echo "DB_PASSWORD=${{ secrets.DB_PASSWORD }}"                   >> env.properties
            echo "AUTH0_DOMAIN=${{ vars.AUTH0_DOMAIN }}"                    >> env.properties
            echo "AUTH0_AUDIENCE=${{ vars.AUTH0_AUDIENCE }}"                >> env.properties
            echo "AUTH0_CLIENT_ID=${{ vars.AUTH0_CLIENT_ID }}"              >> env.properties
            echo "AUTH0_CLIENT_SECRET=${{ secrets.AUTH0_CLIENT_SECRET }}"   >> env.properties

            echo "--- Pulling latest Docker images: ---"
            docker compose -f docker/compose.yaml pull
            docker compose -f docker/compose.yaml up -d --force-recreate --remove-orphans
            
            echo "--- Deployment complete. ---"
          EOF
      
      - name: Cleanup SSH private key
        if: always()
        run: |
          shred -u ~/.ssh/my_ec2_key || rm -f ~/.ssh/my_ec2_key
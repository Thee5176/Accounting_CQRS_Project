name: Build and Test CQRS Application

on:
  push:
    branches:
    - main
    - develop
  pull_request:
    types: [opened, synchronize, reopened]
  workflow_dispatch:

jobs:
  # build-and-test:
  #   environment: "AWS and Supabase"
  #   name: Build and Test CQRS Application
  #   runs-on: ubuntu-latest
  #   env:
  #     DB_URL: ${{ secrets.DB_URL }}
  #     DB_PASSWORD: ${{ secrets.DB_PASSWORD }}
  #     DB_USER: ${{ vars.DB_USER }}
  #     DOCKERHUB_USER: ${{ vars.DOCKERHUB_USER }}
  #     DOCKERHUB_TOKEN: ${{ secrets.DOCKERHUB_TOKEN }}
  #   steps:
  #     - name: Checkout repository with submodules
  #       uses: actions/checkout@v4
  #       with:
  #         submodules: 'recursive'

  #     - name: Set up JDK 21
  #       uses: actions/setup-java@v4
  #       with:
  #         java-version: '21'
  #         distribution: 'temurin'
  #         cache: 'maven'

  #     - name: build Command Unit
  #       run: |
  #         chmod +x mvnw
  #         ./mvnw flyway:migrate
  #         ./mvnw clean package -DskipTests
  #       working-directory: springboot_cqrs_command

  #     - name: Build Query Unit 
  #       run: |
  #           chmod +x mvnw
  #           ./mvnw clean package -DskipTests
  #       working-directory: springboot_cqrs_query

  #     - name: Start All Services
  #       run: |
  #         docker compose build --no-cache
  #         docker compose up -d

  #     - name: Verify services are running
  #       run: docker ps

  #     - name: Log in to Docker Hub
  #       uses: docker/login-action@v3
  #       with:
  #         username: ${{ vars.DOCKERHUB_USER }}
  #         password: ${{ secrets.DOCKERHUB_TOKEN }}
  #     - name: Build and push Docker image
  #       run: |
  #         docker compose -f compose.yaml push

  setup-terraform:
    environment: "AWS and Supabase"
    name: Set up AWS EC2 Instance with Terraform
    # needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup AWS Credential     #TODO: Setup IAM User with Permission and generate credentials with Terraform
        uses: aws-actions/configure-aws-credentials@v2
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ vars.AWS_REGION }}
      - name: Set up SSH key
        env:
          SSH_PRIVATE_KEY: ${{ secrets.EC2_SSH_PRIVATE_KEY }}
        run: |
            mkdir -p ~/.ssh
            echo $SSH_PRIVATE_KEY > ~/.ssh/my_ec2_key
            chmod 600 ~/.ssh/my_ec2_key
            echo "SSH key set up successfully"
        working-directory: envs/dev
      - name: Set up Terraform
        uses: hashicorp/setup-terraform@v2
        with:
          terraform_version: 1.12.2
      - name: Terraform Init, Verify, and Plan
        run: |
          terraform init
          terraform validate
          terraform plan
        working-directory: envs/dev
      - name: Apply Terraform and Deliver Code to EC2
        run: |
          terraform apply -auto-approve  
          ssh -o StrictHostKeyChecking=no -i ~/.ssh/my_ec2_key ec2-user@"$(terraform output -raw instance_public_ip | head -n 1)" << 'EOF'
            echo "--- Clone Repository: ---"
            git clone --recurse-submodules -j3 https://github.com/Thee5176/SpringBoot_CQRS
            cd SpringBoot_CQRS

            echo "--- Pulling latest Docker images: ---"
            docker compose -f compose.yaml up -d --no-build
            
            echo "--- Verifying running containers: ---"
            docker ps
            
            echo "--- Deployment complete. ---"
          EOF
        working-directory: envs/dev